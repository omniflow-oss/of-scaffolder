name: publish-ghcr

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  JAVA_VERSION: ${{ vars.JAVA_VERSION }}
  MANDREL_BUILDER_IMAGE: ${{ vars.MANDREL_BUILDER_IMAGE }}
  MVN_ARGS: "-B -ntp -Dstyle.color=always"
  REGISTRY: ${{ vars.IMAGE_REGISTRY }}

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      services_json: ${{ steps.discover.outputs.services_json }}
    steps:
      - uses: actions/checkout@v4
      - id: discover
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t svcs < <(find services -mindepth 2 -maxdepth 2 -name pom.xml -print0 | xargs -0 -n1 dirname | sort)
          if [ ${#svcs[@]} -eq 0 ]; then
            echo 'services_json=[]' >> "$GITHUB_OUTPUT"
            exit 0
          fi
          json=$(printf '%s\n' "${svcs[@]}" | python -c 'import json,sys; print(json.dumps([l.strip() for l in sys.stdin if l.strip()]))')
          echo "services_json=$json" >> "$GITHUB_OUTPUT"

  publish:
    runs-on: ubuntu-latest
    needs: [ discover ]
    if: ${{ needs.discover.outputs.services_json != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover.outputs.services_json) }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
      - uses: docker/setup-buildx-action@v3
      - uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ runner.os }}-${{ matrix.service }}-${{ github.sha }}
          restore-keys: |
            buildx-${{ runner.os }}-${{ matrix.service }}-
            buildx-${{ runner.os }}-
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build native
        run: |
          mvn $MVN_ARGS -pl "${{ matrix.service }}" -am \
            -DskipTests \
            -Dquarkus.package.type=native \
            -Dquarkus.native.container-build=true \
            -Dquarkus.native.builder-image="${{ env.MANDREL_BUILDER_IMAGE }}" \
            package

      - name: Build & push image
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          SERVICE_NAME=$(basename "${{ matrix.service }}")
          SERVICE_LC=$(echo "$SERVICE_NAME" | tr '[:upper:]' '[:lower:]')
          IMAGE="${{ env.REGISTRY }}/${OWNER_LC}/${SERVICE_LC}"

          TAGS="-t ${IMAGE}:${{ github.sha }}"
          if [ -n "${{ vars.IMAGE_TAG_LATEST }}" ]; then
            TAGS="$TAGS -t ${IMAGE}:${{ vars.IMAGE_TAG_LATEST }}"
          fi

          docker buildx build --push \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            $TAGS \
            -f "${{ matrix.service }}/src/main/docker/Dockerfile.native" \
            "${{ matrix.service }}"

          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
