name: ci

on:
  pull_request:
  push:
    branches: [ "main", "dev", "int" ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  JAVA_VERSION: "21"
  MVN_ARGS: "-B -ntp -Dstyle.color=always"
  MAVEN_OPTS: "-Djava.awt.headless=true -Duser.timezone=UTC"

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      services_json: ${{ steps.discover.outputs.services_json }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: discover
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t svcs < <(find services -mindepth 2 -maxdepth 2 -name pom.xml -print0 | xargs -0 -n1 dirname | sort)
          if [ ${#svcs[@]} -eq 0 ]; then
            echo 'services_json=[]' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Determine changed files for PR/push and narrow native builds to affected services.
          # Fallback: build all services if we can't compute a diff.
          changed_files=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.sha }}"
            changed_files="$(git diff --name-only "$base" "$head" || true)"
          elif [ "${{ github.event_name }}" = "push" ]; then
            before="${{ github.event.before }}"
            head="${{ github.sha }}"
            if [ -n "$before" ] && [ "$before" != "0000000000000000000000000000000000000000" ]; then
              changed_files="$(git diff --name-only "$before" "$head" || true)"
            fi
          fi

          build_all="false"
          if [ -n "$changed_files" ]; then
            if echo "$changed_files" | grep -Eq '^(pom\.xml|bom/|platform-starter/|\.mvn/|libs/)' ; then
              build_all="true"
            fi
          else
            build_all="true"
          fi

          if [ "$build_all" = "true" ]; then
            selected=("${svcs[@]}")
          else
            mapfile -t selected < <(echo "$changed_files" \
              | awk -F/ '$1=="services" && $2!="" {print "services/"$2}' \
              | sort -u)
            if [ ${#selected[@]} -eq 0 ]; then
              echo 'services_json=[]' >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          json=$(printf '%s\n' "${selected[@]}" | python -c 'import json,sys; print(json.dumps([l.strip() for l in sys.stdin if l.strip()]))')
          echo "services_json=$json" >> "$GITHUB_OUTPUT"

  jvm:
    runs-on: ubuntu-latest
    needs: [ discover ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
      - run: mvn $MVN_ARGS clean verify

  native:
    runs-on: ubuntu-latest
    needs: [ discover, jvm ]
    if: ${{ needs.discover.outputs.services_json != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover.outputs.services_json) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
      - uses: docker/setup-buildx-action@v3
      - uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ runner.os }}-${{ matrix.service }}-${{ github.sha }}
          restore-keys: |
            buildx-${{ runner.os }}-${{ matrix.service }}-
            buildx-${{ runner.os }}-
      - name: Native build
        env:
          DOCKER_BUILDKIT: "1"
        run: |
          mvn $MVN_ARGS -pl "${{ matrix.service }}" -am \
            -DskipTests \
            -Dquarkus.package.type=native \
            -Dquarkus.native.container-build=true \
            -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel-builder-image:23.1-java21 \
            package
