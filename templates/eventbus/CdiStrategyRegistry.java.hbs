package {{basePackage}}.shared.strategy;

import io.smallrye.config.SmallRyeConfig;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.enterprise.inject.Instance;
import jakarta.inject.Inject;
import java.util.Optional;

@ApplicationScoped
public class CdiStrategyRegistry implements StrategyRegistry {

  @Inject
  Instance<Object> candidates;

  @Inject
  SmallRyeConfig config;

  @Override
  @SuppressWarnings("unchecked")
  public <T> T get(Class<T> contract, String configKey) {
    final String strategyName = Optional.ofNullable(config.getOptionalValue(configKey, String.class).orElse(null))
        .orElse("default");

    for (Object candidate : candidates) {
      if (!contract.isInstance(candidate)) continue;
      NamedStrategy ann = candidate.getClass().getAnnotation(NamedStrategy.class);
      if (ann != null && ann.value().equals(strategyName)) {
        return (T) candidate;
      }
    }

    throw new IllegalStateException("No strategy found for " + contract.getName() + " name=" + strategyName + " key=" + configKey);
  }
}

